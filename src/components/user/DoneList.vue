<template>
  <ApolloQuery
    ref="userfeed"
    :query="require('../../graphql/userdone.gql')"
    :variables="{ commentCount:5 }"
  >
    <template slot-scope="{ result: { loading, error, data } }">
      <div v-if="loading" class="loading apollo">
        <q-spinner color="primary" size="6em"/>
      </div>
      <div v-else-if="error" class="error apollo">An error occured</div>
      <div v-else-if="data" class="result apollo">
        <div v-if="data.dones.posts.length">
          {{setCursor(data.dones.cursor)}}
          <q-infinite-scroll :handler="loadMoreContent" ref="infiniteScroll">
            <q-list highlight separator no-border>
              <FeedItem
                v-for="post in data.dones.posts"
                :username="post.user.username"
                :created="post.createdAt"
                :content="post.content"
                :key="post.id"
                :postId="post.id"
                :profilePic="post.user.profilepic"
                :commentCount="post.commentCount"
                :comments="post.comments"
                :likeCount="post.likes.total"
                :images="post.images"
                :isLiked="post.likes.isLiked"
                :todoCount="post.todoCount"
                :doneCount="post.doneCount"
                :listedin="post.listedin"
              />
            </q-list>
            <template v-if="data.dones.cursor" v-slot:loading>
              <div class="row justify-center q-my-md">
                <q-spinner-dots color="primary" size="40px"/>
              </div>
            </template>
          </q-infinite-scroll>
        </div>
        <div v-else>
          <EmptyList message="You feed is empty. Start following to get feeds"/>
        </div>
      </div>
    </template>
  </ApolloQuery>
</template>

<script>
import FeedItem from '../../components/FeedItem'
import EmptyList from '../../components/EmptyList'
export default {
  name: 'DoneList',
  components: {
    FeedItem,
    EmptyList
  },
  data () {
    return {
      cursor: null
    }
  },
  methods: {
    date (timestamp) {
      let d = new Date(parseInt(timestamp))
      return d.toDateString() + ' ' + d.toLocaleTimeString()
    },
    createPost () {
      this.opened = true
    },
    loadMoreContent (index, done) {
      let cursor = this.cursor
      if (cursor) {
        this.$refs.userfeed.$apollo.queries.query.fetchMore({
          variables: {
            cursor
          },
          updateQuery: (previousResult, { fetchMoreResult }) => {
            const newContent = fetchMoreResult.userfeed.posts
            const newCursor = fetchMoreResult.userfeed.cursor
            done()
            return {
              userfeed: {
                __typename: previousResult.userfeed.__typename,
                posts: [...previousResult.userfeed.posts, ...newContent],
                cursor: newCursor
              }
            }
          }
        }

        )
      }
    },
    setCursor (cursor) {
      this.cursor = cursor
    }
  }
}
</script>
